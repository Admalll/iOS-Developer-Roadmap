# Что такое Run loop?

![image](https://user-images.githubusercontent.com/47610132/166121061-8efaf7a0-30c3-4466-ac83-efe7af142a58.png)

`Run loop` - цикл обработки событий, который используется для планирования работы и координации получения входящих событий.
Цель выполнения состоит в том, чтобы поддерживать поток занятым, когда есть работа, и переводить поток в спящий режим, когда его нет. 
1. `Run loop` запускается.
2. Источники ввода доставляют события соответствующим обработчикам событий в цикле выполнения - это может привести к вызову IBAction (созданного вами метода), к примеру.
3. Обработка действий и вызванных событий.
4. Этот пункт относится к `MRC - Manual reference counting` К концу цикла возникают задачи подсчета ссылок (объекты освобождаются и т.д.).
5. `Run loop` заканчивает работу.
6. `Run loop` может повторить свои действия.

В OSX/iOS у нас уже есть реализация этого механизма в виде NSRunLoop и CFRunLoopRef. 
`CFRunLoopRef` является частью фреймворка CoreFoundation. Он предоставляет API для функций на чистом C, которое является потокобезопасным.

`NSRunLoop` — это обертка, берущая за основу CFRunLoopRef, которая предоставляет объектно-ориентированное API, но это API не является потокобезопасным.

  - Метод CFRunLoop - можно вызвать из любого потока.
  - Метод NSRunLoop и RunLoop - можно вызвать только из того же потока, в котором запущен RunLoop.

В системе по умолчанию предусмотрено пять режимов:
1. `kCFRunLoopDefaultMode`: дефолтный для вашего приложения режим, обычно в этом режиме выполняется основной (main) поток.
2. `UITrackingRunLoopMode`: режим отслеживания интерфейса, используемый ScrollView для отслеживания касаний и слайдов, чтобы гарантировать, что интерфейс не зависит от других режимов при слайдинге.
3. `UIInitializationRunLoopMode`: первый режим, в который приложение входит при запуске, он не будет больше использоваться после завершения запуска.
4. `GSEventReceiveRunLoopMode`: внутренний режим для приема системных событий, обычно не используется.
5. `kCFRunLoopCommonModes`: это режим-заполнитель, не имеющий практического значения.

![image](https://user-images.githubusercontent.com/47610132/166122250-2e0bf82b-1871-410e-a4c5-a15f4752b656.png)

В Cocoa для каждого потока, системой, обычно создается свой **Run Loop** — цикл, который обрабатывает таймеры и события, а так же усыпляет поток, если ему нечего делать в текущий момент. 
Run Loop поддерживает 2 типа событий:
  - `Input sources` — асинхронные события. Обычно это сообщения от других потоков, приложений или системных вызовов. Основанные на портах или созданные пользователем, или источники, выполняющие селекторы.
  - `Timer sources` — синхронные события. Таймеры. Вызываются синхронно с известным интервалом.Каждый Run Loop определяет режим, в котором он работает: от режима зависит, какие события будут обработаны и кто будет об этом оповещен.

 > Runloop и поток связаны вместе. Каждый поток (включая главный поток) имеет соответствующий объект Runloop. Невозможно создать объект Runloop самостоятельно, но можно получить объект Runloop, предоставленный системой.

**Четыре функции цикла исполнения:**
  - Принимать вводимые пользователем данные, не прерывая выполнения программы.
  - Решать, когда события должны обрабатываться программой.
  - Разделять вызовы.
  - Экономить время процессора


При запуске Run Loop можно явно указать, какие источники событий ему стоит отслеживать на текущей итерации.
Для этого существуют несколько режимов, называемых `Run Loop Modes`. Внимания заслуживают:
  - .default (основной режим), 
  - .tracking (режим отслеживания нажатий)
  - .common (комбинация предыдущих двух режимов). 

Когда пользователь начинает взаимодействие с UI, основной Run Loop переходит в режим .tracking и временно откладывает обработку всех остальных событий, чтобы обеспечить плавность интерфейса.

# Дополнительные материалы:
1. [Документация от Apple](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html)
2. [RunLoop.main vs DispatchQueue.main: The differences explained](https://www.avanderlee.com/combine/runloop-main-vs-dispatchqueue-main/)
3. [RunLoop на главном потоке / Антон Сергеев](https://www.youtube.com/watch?v=s8B6t5XnB7M)
4. [Пример использования autoreleasepool в Swift](https://proswift.ru/pamyat-i-autoreleasepool-dlya-ciklov/)
